name: AI Improvement Loop

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰'
        required: true
        default: 'verification'
        type: choice
        options:
          - verification
          - adoption
      strategy:
        description: 'æ”¹å–„å¯¾è±¡æˆ¦ç•¥ï¼ˆç©ºæ¬„ã§å…¨æˆ¦ç•¥ï¼‰'
        required: false
        type: string
      force_improvement:
        description: 'å¼·åˆ¶æ”¹å–„å®Ÿè¡Œ'
        required: false
        default: false
        type: boolean
  schedule:
    - cron: '0 2 * * *' # æ¯æ—¥JST11æ™‚ï¼ˆUTC2æ™‚ï¼‰ã«æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ

jobs:
  ai-improvement:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      pull-requests: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
      - name: Set execution mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ github.event.inputs.mode }}" >> $GITHUB_ENV
            echo "strategy=${{ github.event.inputs.strategy }}" >> $GITHUB_ENV
            echo "force_improvement=${{ github.event.inputs.force_improvement }}" >> $GITHUB_ENV
          else
            echo "mode=verification" >> $GITHUB_ENV
            echo "strategy=" >> $GITHUB_ENV
            echo "force_improvement=false" >> $GITHUB_ENV
          fi

      # 5. ãƒ–ãƒ©ãƒ³ãƒä½œæˆï¼ˆæ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰
      - name: Create verification branch
        if: env.mode == 'verification'
        run: |
          BRANCH_NAME="ai-improvement-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b $BRANCH_NAME
          git push origin $BRANCH_NAME

      # 6. ç¾åœ¨ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
      - name: Run current performance baseline
        id: baseline
        env:
          OOS_FIXED_TICKERS: ${{ env.OOS_FIXED_TICKERS }}
          EXTRA_TICKERS: ${{ vars.EXTRA_TICKERS }}
          SAMPLE_SIZE: 12
          OOS_RANDOM_SIZE: 8
          HOLDOUT_MONTHS: 12
        run: |
          python -m scripts.run_backtest_enhanced --baseline-only
          echo "baseline_completed=true" >> $GITHUB_ENV

      # 7. AIæ”¹å–„ææ¡ˆç”Ÿæˆ
      - name: Generate AI improvement proposals
        id: proposals
        run: |
          python -m scripts.generate_improvements \
            --mode ${{ env.mode }} \
            --strategy "${{ env.strategy }}" \
            --force ${{ env.force_improvement }}
          
          if [ -f "improvement_proposals.json" ]; then
            echo "proposals_generated=true" >> $GITHUB_ENV
            echo "proposal_count=$(jq length improvement_proposals.json)" >> $GITHUB_ENV
          else
            echo "proposals_generated=false" >> $GITHUB_ENV
            echo "proposal_count=0" >> $GITHUB_ENV
          fi

      # 8. æ”¹å–„ææ¡ˆã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Test improvement proposals
        if: steps.proposals.outputs.proposals_generated == 'true'
        id: testing
        env:
          OOS_FIXED_TICKERS: ${{ env.OOS_FIXED_TICKERS }}
          EXTRA_TICKERS: ${{ vars.EXTRA_TICKERS }}
          SAMPLE_SIZE: 12
          OOS_RANDOM_SIZE: 8
          HOLDOUT_MONTHS: 12
        run: |
          python -m scripts.test_improvements \
            --mode ${{ env.mode }} \
            --branch-name ${{ env.branch_name }}
          
          echo "testing_completed=true" >> $GITHUB_ENV

      # 9. æ”¹å–„çµæœã®è©•ä¾¡
      - name: Evaluate improvement results
        if: steps.testing.outputs.testing_completed == 'true'
        id: evaluation
        run: |
          python -m scripts.evaluate_improvements \
            --mode ${{ env.mode }} \
            --branch-name ${{ env.branch_name }}
          
          if [ -f "evaluation_results.json" ]; then
            echo "evaluation_completed=true" >> $GITHUB_ENV
            echo "successful_improvements=$(jq '.successful_improvements | length' evaluation_results.json)" >> $GITHUB_ENV
          else
            echo "evaluation_completed=false" >> $GITHUB_ENV
            echo "successful_improvements=0" >> $GITHUB_ENV
          fi

      # 10. æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
      - name: Create Pull Request (Verification Mode)
        if: env.mode == 'verification' && steps.evaluation.outputs.evaluation_completed == 'true' && steps.evaluation.outputs.successful_improvements != '0'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch_name }}
          title: "ğŸ¤– AIæ”¹å–„ææ¡ˆ: ${{ steps.evaluation.outputs.successful_improvements }}ä»¶ã®æ”¹å–„"
          body: |
            ## AIæ”¹å–„ææ¡ˆ
            
            **å®Ÿè¡Œæ—¥æ™‚**: ${{ github.event_name == 'schedule' && 'è‡ªå‹•å®Ÿè¡Œ' || 'æ‰‹å‹•å®Ÿè¡Œ' }}
            **æ”¹å–„ä»¶æ•°**: ${{ steps.evaluation.outputs.successful_improvements }}ä»¶
            
            ### æ”¹å–„å†…å®¹
            - è©³ç´°ã¯æ·»ä»˜ã®è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„
            
            ### æ¤œè¨¼çµæœ
            - ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ: [ãƒ¬ãƒãƒ¼ãƒˆ](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)
            - æ”¹å–„å±¥æ­´: [å±¥æ­´ãƒ¬ãƒãƒ¼ãƒˆ](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/improvement_history.html)
            
            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«ãƒãƒ¼ã‚¸
            2. æ¡ç”¨ãƒ¢ãƒ¼ãƒ‰ã§æœ¬æ ¼å°å…¥
          labels: |
            ai-improvement
            verification
            automated

      # 11. æ¡ç”¨ãƒ¢ãƒ¼ãƒ‰: ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸
      - name: Merge to main (Adoption Mode)
        if: env.mode == 'adoption' && steps.evaluation.outputs.evaluation_completed == 'true' && steps.evaluation.outputs.successful_improvements != '0'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ”¹å–„å±¥æ­´ã‚’æ›´æ–°
          python -m scripts.update_improvement_history --adopt-successful
          
          # ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
          git add .
          git commit -m "ğŸ¤– AIæ”¹å–„ã‚’æ¡ç”¨: ${{ steps.evaluation.outputs.successful_improvements }}ä»¶ã®æ”¹å–„"
          git push origin main

      # 12. ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      - name: Generate reports
        if: always()
        run: |
          python -m scripts.make_index
          python -m scripts.generate_improvement_reports

      # 13. GitHub Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to GitHub Pages
        if: always()
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports

      - name: Deploy to GitHub Pages
        if: always()
        uses: actions/deploy-pages@v4

      # 14. Slacké€šçŸ¥
      - name: Notify to Slack
        if: always()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          EXECUTION_MODE: ${{ env.mode }}
          PROPOSAL_COUNT: ${{ steps.proposals.outputs.proposal_count }}
          SUCCESSFUL_IMPROVEMENTS: ${{ steps.evaluation.outputs.successful_improvements }}
        run: |
          python -m scripts.notify_ai_improvement

      # 15. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-improvement-results
          path: |
            reports/
            improvement_proposals.json
            evaluation_results.json
            data/improvement_history.json

  # 16. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  rollback:
    runs-on: ubuntu-latest
    needs: ai-improvement
    if: needs.ai-improvement.result == 'failure' && env.mode == 'adoption'
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Execute rollback
        run: |
          python -m scripts.rollback_improvements --auto-rollback

      - name: Create rollback notification
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: rollback-$(date +%Y%m%d-%H%M%S)
          title: "ğŸš¨ è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ"
          body: |
            ## è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
            
            AIæ”¹å–„ãƒ«ãƒ¼ãƒ—ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã€è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚
            
            **å®Ÿè¡Œæ—¥æ™‚**: $(date)
            **ã‚¨ãƒ©ãƒ¼å†…å®¹**: æ”¹å–„ãƒ«ãƒ¼ãƒ—å®Ÿè¡Œå¤±æ•—
            
            ### å¯¾å¿œå†…å®¹
            - å‰å›ã®å®‰å®šç‰ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¾©å…ƒ
            - æ”¹å–„å±¥æ­´ã®æ›´æ–°
            - ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ç¢ºä¿
            
            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            1. ã‚¨ãƒ©ãƒ¼ã®åŸå› èª¿æŸ»
            2. æ‰‹å‹•ã§ã®æ”¹å–„æ¤œè¨¼
            3. ã‚·ã‚¹ãƒ†ãƒ å®‰å®šæ€§ã®ç¢ºèª
          labels: |
            rollback
            automated
            urgent
