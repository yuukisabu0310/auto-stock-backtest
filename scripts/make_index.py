# scripts/make_index.py
import os
import json
from pathlib import Path
from html import escape
from datetime import datetime
import pandas as pd

ROOT = Path("reports")
ROOT.mkdir(exist_ok=True, parents=True)

def load_improvement_history():
    """ÊîπÂñÑÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø"""
    try:
        history_file = Path("data/improvement_history.json")
        if history_file.exists():
            with open(history_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                # „Éá„Éº„Çø„Åå„É™„Çπ„Éà„ÅÆÂ†¥Âêà„ÅØËæûÊõ∏ÂΩ¢Âºè„Å´Â§âÊèõ
                if isinstance(data, list):
                    return {"improvements": data, "summary": {}}
                # „Éá„Éº„Çø„ÅåËæûÊõ∏„ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
                elif isinstance(data, dict):
                    return data
                else:
                    return {"improvements": [], "summary": {}}
    except Exception:
        pass
    return {"improvements": [], "summary": {}}

def load_backtest_summary():
    """„Éê„ÉÉ„ÇØ„ÉÜ„Çπ„ÉàÁµêÊûú„ÅÆ„Çµ„Éû„É™„Éº„ÇíË™≠„ÅøËæº„Åø"""
    summary = {}
    try:
        for strat_dir in ROOT.iterdir():
            if strat_dir.is_dir():
                summary_file = strat_dir / "_all_summary.csv"
                if summary_file.exists():
                    df = pd.read_csv(summary_file)
                    if not df.empty:
                        # ÊúÄÊñ∞„ÅÆÁµêÊûú„ÇíÂèñÂæó
                        latest = df.iloc[-1] if len(df) > 0 else df.iloc[0]
                        summary[strat_dir.name] = {
                            'total_return': latest.get('Total Return [%]', 0),
                            'sharpe_ratio': latest.get('Sharpe Ratio', 0),
                            'max_drawdown': latest.get('Max. Drawdown [%]', 0),
                            'win_rate': latest.get('Win Rate [%]', 0),
                            'profit_factor': latest.get('Profit Factor', 0)
                        }
    except Exception:
        pass
    return summary

def generate_dashboard():
    """Áµ±Âêà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíÁîüÊàê"""
    
    # „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
    history = load_improvement_history()
    backtest_summary = load_backtest_summary()
    
    # ÊîπÂñÑÂ±•Ê≠¥„ÅÆÁµ±Ë®à
    improvements = history.get("improvements", [])
    total_improvements = len(improvements)
    successful_improvements = len([i for i in improvements if i.get('status') == 'adopted'])
    pending_improvements = len([i for i in improvements if i.get('status') == 'success'])
    
    # ÊúÄÊñ∞„ÅÆÊîπÂñÑ
    recent_improvements = improvements[-5:] if improvements else []
    
    html_content = f"""
    <!DOCTYPE html>
    <html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Auto Stock Backtest Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            * {{
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }}
            
            body {{
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                color: #333;
            }}
            
            .container {{
                max-width: 1400px;
                margin: 0 auto;
                padding: 20px;
            }}
            
            .header {{
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 30px;
                margin-bottom: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                text-align: center;
            }}
            
            .header h1 {{
                font-size: 2.5em;
                color: #2c3e50;
                margin-bottom: 10px;
                font-weight: 700;
            }}
            
            .header p {{
                color: #7f8c8d;
                font-size: 1.1em;
            }}
            
            .stats-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }}
            
            .stat-card {{
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 25px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease;
            }}
            
            .stat-card:hover {{
                transform: translateY(-5px);
            }}
            
            .stat-card h3 {{
                color: #2c3e50;
                font-size: 1.2em;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 10px;
            }}
            
            .stat-value {{
                font-size: 2.5em;
                font-weight: 700;
                margin-bottom: 10px;
            }}
            
            .stat-label {{
                color: #7f8c8d;
                font-size: 0.9em;
            }}
            
            .positive {{ color: #27ae60; }}
            .negative {{ color: #e74c3c; }}
            .neutral {{ color: #3498db; }}
            
            .content-grid {{
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 30px;
                margin-bottom: 30px;
            }}
            
            .main-content {{
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }}
            
            .sidebar {{
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 30px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }}
            
            .section {{
                margin-bottom: 30px;
            }}
            
            .section h2 {{
                color: #2c3e50;
                font-size: 1.5em;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #ecf0f1;
            }}
            
            .strategy-grid {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }}
            
            .strategy-card {{
                background: #f8f9fa;
                border-radius: 12px;
                padding: 20px;
                border-left: 4px solid #3498db;
            }}
            
            .strategy-card h3 {{
                color: #2c3e50;
                margin-bottom: 15px;
                font-size: 1.2em;
            }}
            
            .metric-row {{
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                padding: 5px 0;
            }}
            
            .metric-label {{
                color: #7f8c8d;
                font-size: 0.9em;
            }}
            
            .metric-value {{
                font-weight: 600;
                font-size: 0.9em;
            }}
            
            .improvement-list {{
                list-style: none;
            }}
            
            .improvement-item {{
                background: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                margin-bottom: 10px;
                border-left: 4px solid #27ae60;
            }}
            
            .improvement-item h4 {{
                color: #2c3e50;
                margin-bottom: 8px;
                font-size: 1em;
            }}
            
            .improvement-meta {{
                color: #7f8c8d;
                font-size: 0.8em;
                margin-bottom: 5px;
            }}
            
            .status-badge {{
                display: inline-block;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 0.7em;
                font-weight: 600;
                text-transform: uppercase;
            }}
            
            .status-adopted {{ background: #d5f4e6; color: #27ae60; }}
            .status-success {{ background: #d6eaf8; color: #3498db; }}
            .status-failed {{ background: #fadbd8; color: #e74c3c; }}
            
            .chart-container {{
                position: relative;
                height: 300px;
                margin: 20px 0;
            }}
            
            .footer {{
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-radius: 20px;
                padding: 20px;
                text-align: center;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            }}
            
            .footer a {{
                color: #3498db;
                text-decoration: none;
                margin: 0 10px;
            }}
            
            .footer a:hover {{
                text-decoration: underline;
            }}
            
            @media (max-width: 768px) {{
                .content-grid {{
                    grid-template-columns: 1fr;
                }}
                
                .stats-grid {{
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                }}
            }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üöÄ Auto Stock Backtest Dashboard</h1>
                <p>AIÈßÜÂãï„ÅÆËá™ÂãïÊ†™Âºè„Éê„ÉÉ„ÇØ„ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É† - „É™„Ç¢„É´„Çø„Ç§„É†ÊîπÂñÑ„Çµ„Ç§„ÇØ„É´</p>
                <p>ÊúÄÁµÇÊõ¥Êñ∞: {datetime.now().strftime('%YÂπ¥%mÊúà%dÊó• %H:%M')}</p>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üìä Á∑èÊîπÂñÑÂõûÊï∞</h3>
                    <div class="stat-value neutral">{total_improvements}</div>
                    <div class="stat-label">AIÊîπÂñÑÊèêÊ°à„ÅÆÁ∑èÊï∞</div>
                </div>
                <div class="stat-card">
                    <h3>‚úÖ Êé°Áî®Ê∏à„ÅøÊîπÂñÑ</h3>
                    <div class="stat-value positive">{successful_improvements}</div>
                    <div class="stat-label">Êú¨Áï™Áí∞Â¢É„ÅßÊé°Áî®„Åï„Çå„ÅüÊîπÂñÑ</div>
                </div>
                <div class="stat-card">
                    <h3>‚è≥ Ê§úË®ºÂæÖ„Å°</h3>
                    <div class="stat-value neutral">{pending_improvements}</div>
                    <div class="stat-label">Ê§úË®ºÊàêÂäü„Éª„É¨„Éì„É•„ÉºÂæÖ„Å°</div>
                </div>
                <div class="stat-card">
                    <h3>üìà Êà¶Áï•Êï∞</h3>
                    <div class="stat-value neutral">{len(backtest_summary)}</div>
                    <div class="stat-label">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Êà¶Áï•</div>
                </div>
            </div>
            
            <div class="content-grid">
                <div class="main-content">
                    <div class="section">
                        <h2>üìà Êà¶Áï•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</h2>
                        <div class="strategy-grid">
    """
    
    # Êà¶Áï•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Ç´„Éº„Éâ
    for strategy_name, metrics in backtest_summary.items():
        total_return = metrics.get('total_return', 0)
        sharpe_ratio = metrics.get('sharpe_ratio', 0)
        max_drawdown = metrics.get('max_drawdown', 0)
        win_rate = metrics.get('win_rate', 0)
        profit_factor = metrics.get('profit_factor', 0)
        
        return_color = "positive" if total_return > 0 else "negative"
        sharpe_color = "positive" if sharpe_ratio > 1 else "neutral"
        drawdown_color = "negative" if max_drawdown < -10 else "neutral"
        
        html_content += f"""
                            <div class="strategy-card">
                                <h3>{strategy_name}</h3>
                                <div class="metric-row">
                                    <span class="metric-label">Á∑è„É™„Çø„Éº„É≥</span>
                                    <span class="metric-value {return_color}">{total_return:.2f}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">„Ç∑„É£„Éº„Éó„É¨„Ç∑„Ç™</span>
                                    <span class="metric-value {sharpe_color}">{sharpe_ratio:.2f}</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">ÊúÄÂ§ß„Éâ„É≠„Éº„ÉÄ„Ç¶„É≥</span>
                                    <span class="metric-value {drawdown_color}">{max_drawdown:.2f}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">ÂãùÁéá</span>
                                    <span class="metric-value neutral">{win_rate:.1f}%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">„Éó„É≠„Éï„Ç£„ÉÉ„Éà„Éï„Ç°„ÇØ„Çø„Éº</span>
                                    <span class="metric-value neutral">{profit_factor:.2f}</span>
                                </div>
                            </div>
        """
    
    html_content += """
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>üìä „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊé®Áßª</h2>
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="sidebar">
                    <div class="section">
                        <h2>ü§ñ ÊúÄÊñ∞„ÅÆÊîπÂñÑ</h2>
                        <ul class="improvement-list">
    """
    
    # ÊúÄÊñ∞„ÅÆÊîπÂñÑÂ±•Ê≠¥
    for improvement in recent_improvements:
        strategy_name = improvement.get('strategy_name', 'Unknown')
        status = improvement.get('status', 'unknown')
        score = improvement.get('improvement_score', 0)
        timestamp = improvement.get('timestamp', '')
        
        status_class = f"status-{status}"
        status_display = {
            'adopted': 'Êé°Áî®Ê∏à„Åø',
            'success': 'Ê§úË®ºÊàêÂäü',
            'failed': 'Â§±Êïó',
            'pending': '‰øùÁïô'
        }.get(status, status)
        
        html_content += f"""
                            <li class="improvement-item">
                                <h4>{strategy_name}</h4>
                                <div class="improvement-meta">
                                    <span class="status-badge {status_class}">{status_display}</span>
                                    <span>„Çπ„Ç≥„Ç¢: {score:.2f}</span>
                                </div>
                                <div class="improvement-meta">{timestamp}</div>
                            </li>
        """
    
    html_content += """
                        </ul>
                    </div>
                    
                    <div class="section">
                        <h2>üîó Ë©≥Á¥∞„É¨„Éù„Éº„Éà</h2>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 10px;">
                                <a href="improvement_history.html" style="color: #3498db; text-decoration: none;">
                                    üìã ÊîπÂñÑÂ±•Ê≠¥Ë©≥Á¥∞
                                </a>
                            </li>
                            <li style="margin-bottom: 10px;">
                                <a href="comparison_report.html" style="color: #3498db; text-decoration: none;">
                                    üìä ÊØîËºÉ„É¨„Éù„Éº„Éà
                                </a>
                            </li>
                            <li style="margin-bottom: 10px;">
                                <a href="timeline_report.html" style="color: #3498db; text-decoration: none;">
                                    ‚è∞ „Çø„Ç§„É†„É©„Ç§„É≥
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>
                    <a href="https://github.com/your-username/auto-stock-backtest">GitHub</a> |
                    <a href="improvement_history.html">ÊîπÂñÑÂ±•Ê≠¥</a> |
                    <a href="comparison_report.html">ÊØîËºÉ„É¨„Éù„Éº„Éà</a> |
                    <a href="timeline_report.html">„Çø„Ç§„É†„É©„Ç§„É≥</a>
                </p>
                <p style="margin-top: 10px; color: #7f8c8d; font-size: 0.9em;">
                    Auto Stock Backtest System - AI Improvement Loop
                </p>
            </div>
        </div>
        
        <script>
            // „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÅ„É£„Éº„Éà
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const performanceData = {
                labels: {strategy_labels},
                datasets: [
                    {
                        label: 'Á∑è„É™„Çø„Éº„É≥ (%)',
                        data: {return_data},
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4
                    },
                    {
                        label: '„Ç∑„É£„Éº„Éó„É¨„Ç∑„Ç™',
                        data: {sharpe_data},
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }
                ]
            };
            
            new Chart(ctx, {{
                type: 'line',
                data: performanceData,
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {{
                        intersect: false,
                        mode: 'index'
                    }},
                    scales: {{
                        y: {{
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {{
                                display: true,
                                text: 'Á∑è„É™„Çø„Éº„É≥ (%)'
                            }}
                        }},
                        y1: {{
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {{
                                display: true,
                                text: '„Ç∑„É£„Éº„Éó„É¨„Ç∑„Ç™'
                            }},
                            grid: {{
                                drawOnChartArea: false
                            }}
                        }}
                    }}
                }}
            }});
        </script>
    </body>
    </html>
    """
    
    # „ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„ÅÆÊ∫ñÂÇô
    strategy_labels = list(backtest_summary.keys())
    return_data = [backtest_summary[s].get('total_return', 0) for s in strategy_labels]
    sharpe_data = [backtest_summary[s].get('sharpe_ratio', 0) for s in strategy_labels]
    
    # „Éá„Éº„Çø„ÇíJSONÂΩ¢Âºè„ÅßÂüã„ÇÅËæº„Åø
    html_content = html_content.replace('{strategy_labels}', json.dumps(strategy_labels))
    html_content = html_content.replace('{return_data}', json.dumps(return_data))
    html_content = html_content.replace('{sharpe_data}', json.dumps(sharpe_data))
    
    return html_content

def build():
    """„É°„Ç§„É≥„ÅÆ„Éì„É´„ÉâÈñ¢Êï∞"""
    # Áµ±Âêà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„ÇíÁîüÊàê
    dashboard_html = generate_dashboard()
    (ROOT / "index.html").write_text(dashboard_html, encoding="utf-8")
    print("reports/index.html generated (Unified Dashboard)")
    
    # ÂæìÊù•„ÅÆ„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„ÇÇÁîüÊàêÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
    generate_file_list()

def generate_file_list():
    """ÂæìÊù•„ÅÆ„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„ÇíÁîüÊàê"""
    parts = []
    parts.append("<!doctype html><html><head>")
    parts.append("<meta charset='utf-8'>")
    parts.append("<meta name='viewport' content='width=device-width,initial-scale=1'>")
    parts.append("<title>Backtest Reports - File List</title>")
    parts.append("<style>body{font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;line-height:1.5} h1{font-size:20px} h2{font-size:18px;margin-top:18px} ul{padding-left:18px} a{word-break:break-all}</style>")
    parts.append("</head><body>")
    parts.append("<h1>Backtest Reports - File List</h1>")
    parts.append('<p><a href="index.html">‚Üê „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Êàª„Çã</a></p>')

    # Êà¶Áï•„Åî„Å®„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™
    for strat_dir in sorted([p for p in ROOT.iterdir() if p.is_dir()]):
        files = sorted(strat_dir.glob("*"))
        if not files:
            continue
        parts.append(f"<h2>{escape(strat_dir.name)}</h2><ul>")
        # „Åæ„ÅöÊ¶ÇË¶Å„Éï„Ç°„Ç§„É´„ÇíÂÖà„Å´
        for name in ["_params.txt", "_all_summary.csv"]:
            fp = strat_dir / name
            if fp.exists():
                parts.append(li(fp))
        # „Åù„ÅÆ„Åª„Åã„ÅÆ„Éï„Ç°„Ç§„É´
        for f in files:
            if f.name in ["_params.txt", "_all_summary.csv"]:
                continue
            parts.append(li(f))
        parts.append("</ul>")

    # „É´„Éº„ÉàÁõ¥‰∏ã„ÅÆ„É≠„Ç∞„Å™„Å©
    root_files = [p for p in ROOT.iterdir() if p.is_file()]
    if root_files:
        parts.append("<h2>Others</h2><ul>")
        for f in sorted(root_files):
            parts.append(li(f))
        parts.append("</ul>")

    parts.append("</body></html>")
    (ROOT / "files.html").write_text("\n".join(parts), encoding="utf-8")
    print("reports/files.html generated (File List)")

def li(path: Path) -> str:
    href = path.as_posix()
    return f"<li><a href='{escape(href)}'>{escape(path.name)}</a></li>"

if __name__ == "__main__":
    build()
